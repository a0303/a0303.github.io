<!DOCTYPE html>
<!--file:///D:/sample_2.html-->
<html>

<head>
  <meta charset="utf-8">
  <title>Presentation training system ver1</title>
  <meta name="description" content="Presentation training system">
  <script src="https://aframe.io/releases/0.4.0/aframe.min.js"></script>
  <script src="https://rawgit.com/bryik/aframe-bmfont-text-component/master/dist/aframe-bmfont-text-component.min.js"></script>
  <script type="text/javascript">
    var StartStop=0; //実験開始・停止を決める変数
    var totalTickCount = 0; //プレゼンテーション全体の時間を格納する変数
    var objectGazeTickCount = {}; //各聴衆を見ている時間を格納する配列
    var gazedObjectID; //見ている聴講者のIDを格納する変数

    //StartStopButtonにカーソルを合わせると変数StartStopに1加算する
    AFRAME.registerComponent('start-stop', {
      init: function() {
        this.el.addEventListener("click", function (evt) {
          StartStop++;
          if (StartStop==1){
            document.getElementById("text2").setAttribute("bmfont-text", "text", "start"+"\n");
          }else if(StartStop>1){
            document.getElementById("text2").setAttribute("bmfont-text", "text", "stop"+"\n");
          }
        });
      }
    });
    //聴衆にカーソルを合わせると聴衆のIDを取得しgazedObjectIDに格納,
    //離すとgazedObjectIDを初期化する
    AFRAME.registerComponent('cursor-listener', {
      init: function() {
        this.el.addEventListener("mouseenter", function(evt) {
          gazedObjectID = this.getAttribute("id");
        });
        this.el.addEventListener("mouseleave", function(evt) {
          gazedObjectID = null;
        });
      }
    });
    
    //テキストを更新する
    var updateText = function() {
      if (StartStop==1) {
        ++totalTickCount;
        if (gazedObjectID != null) {
          if (! (gazedObjectID in objectGazeTickCount))
            objectGazeTickCount[gazedObjectID] = 0;
          objectGazeTickCount[gazedObjectID]++;
        }

        var text = "";
        for (var i in objectGazeTickCount) {
          text += i + " " + 100*(objectGazeTickCount[i] / totalTickCount) + "\n";
        }
        document.getElementById("text").setAttribute("bmfont-text", "text", text);
      }
    };
    setInterval(updateText, 500);
    
  </script>
</head>

<body>
  <a-scene>
    <a-camera>
      <a-cursor fuse="true" fuse-timeout="500" position="0 0 -1" material="color: blue; shader: flat">
      </a-cursor>
      <a-entity id="text" position="-0.6 1 -3" bmfont-text="color: black;">
      </a-entity>
      <a-entity id="text2" position="-0.2 -0.2 -2" bmfont-text="color: blue;">
      </a-entity>
    </a-camera>

    <assets>
      <img id="floor" src="https://a0303.github.io/floor.jpg" >
      <img id="ceiling" src="https://a0303.github.io/ceiling.jpg">
      <img src="wall" src="https://a0303.github.io/wall.jpg">
    </assets>

    <!--front wall-->
    <a-plane src="#wall" position="-4 2.5 -10" rotation="0 0 0" width="12" height="5" color="#81F"></a-plane>
    <!--behind wall-->
    <a-plane src="#wall" position="-4 2.5 2" rotation="180 0 0" width="12" height="5" color="#81F"></a-plane>
    <!--right wall-->
    <a-plane src="#wall" position="2 2.5 -4" rotation="0 -90 0" width="12" height="5" color="#81F"></a-plane>
    <!--left wall-->
    <a-plane src="#wall" position="-10 2.5 -4" rotation="0 90 0" width="12" height="5" color="#81F"></a-plane>
    <!--ceiling-->
    <a-plane src="#ceiling" position="-4 5 -4" rotation="90 0 0" width="12" height="12" color="#DF7401"></a-plane>
    <!--floor-->
    <a-plane src="#floor" position="-4 0 -4" rotation="-90 0 0" width="12" height="12" color="#DF7401"></a-plane>
    <!--screen-->
    <a-plane position="-3 2.5 1.9" rotation="180 0 0" width="4" height="3" color="#00FF40"></a-plane>
    <!--listener-->
    <a-cylinder id="listener_1" cursor-listener position="0 0.75 -5" radius="0.5" height="1.5" color="#4CC3D9"></a-cylinder>
    <a-cylinder id="listener_2" cursor-listener position="-2 0.75 -5" radius="0.5" height="1.5" color="#4CC3D9"></a-cylinder>
    <a-cylinder id="listener_3" cursor-listener position="-4 0.75 -5" radius="0.5" height="1.5" color="#4CC3D9"></a-cylinder>
    <a-cylinder id="listener_4" cursor-listener position="-6 0.75 -5" radius="0.5" height="1.5" color="#4CC3D9"></a-cylinder>

    <a-sky id="sky" color="#ECECEC"></a-sky>

    <a-plane id=StartStopButton start-stop position="0 0.1 -2" rotation="-90 0 0" width="0.5" height="0.5" color="#FF0000">
    </a-plane>

  </a-scene>
</body>

</html>
